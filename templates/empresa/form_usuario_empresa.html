{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ empresa.nombre_fantasia }}{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/dental-theme.css' %}">
<style>
    body, .container-fluid {
        font-family: 'Poppins', sans-serif !important;
    }
    
    .card {
        border: 1px solid #AED6F1;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }

    .card-header {
        background-color: #E8F4FC;
        border-bottom: 1px solid #AED6F1;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
    }

    .card-header h3 {
        color: #1A5276;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    .card-header p {
        color: #2874A6;
        margin: 0.5rem 0 0 0;
        font-size: 0.95rem;
    }

    .card-body {
        padding: 2rem;
    }

    .form-label {
        color: #1A5276;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 1px solid #AED6F1;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #2874A6;
        box-shadow: 0 0 0 0.2rem rgba(40, 116, 166, 0.25);
    }

    .form-check-input:checked {
        background-color: #1A5276;
        border-color: #1A5276;
    }

    .form-check-label {
        color: #1A5276;
        font-weight: 500;
    }

    .form-text {
        color: #7f8c8d;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .btn-primary {
        background-color: #1A5276;
        border-color: #1A5276;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .btn-primary:hover {
        background-color: #2874A6;
        border-color: #2874A6;
    }

    .btn-secondary {
        background-color: #95a5a6;
        border-color: #95a5a6;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .btn-secondary:hover {
        background-color: #7f8c8d;
        border-color: #7f8c8d;
    }

    .alert {
        border-radius: 8px;
        border: none;
        padding: 1rem 1.5rem;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .text-danger {
        color: #e74c3c !important;
    }

    .text-muted {
        color: #7f8c8d !important;
    }

    .mb-3 {
        margin-bottom: 1.5rem !important;
    }

    .mb-4 {
        margin-bottom: 2rem !important;
    }

    .row {
        margin-left: -0.75rem;
        margin-right: -0.75rem;
    }

    .col-md-6, .col-12 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }

    .fas {
        color: #1A5276;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }

    .badge.bg-success {
        background-color: #2ecc71 !important;
        color: white;
    }

    .badge.bg-danger {
        background-color: #e74c3c !important;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3>
                                <i class="fas fa-user-plus me-2"></i>
                                {{ titulo }}
                            </h3>
                            <p>{{ empresa.nombre_fantasia }} - {% if usuario_empresa %}Modifique la información del usuario{% else %}Complete el formulario para registrar un nuevo usuario{% endif %}</p>
                        </div>
                        <a href="{% url 'empresa:listar_usuarios_empresa' empresa.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Por favor corrige los siguientes errores:</h6>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if usuario_empresa %}
                    <!-- Información del usuario que se está editando -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-user-edit me-2"></i>Editando Usuario</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Email actual:</strong> {{ usuario_empresa.usuario.email }}
                            </div>
                            <div class="col-md-6">
                                <strong>Estado:</strong> 
                                {% if usuario_empresa.activo %}
                                    <span class="badge bg-success">Activo</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactivo</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if usuario_empresa.fecha_inicio or usuario_empresa.fecha_fin %}
                        <div class="row mt-2">
                            {% if usuario_empresa.fecha_inicio %}
                            <div class="col-md-6">
                                <strong>Fecha de inicio:</strong> {{ usuario_empresa.fecha_inicio|date:"d/m/Y" }}
                            </div>
                            {% endif %}
                            {% if usuario_empresa.fecha_fin %}
                            <div class="col-md-6">
                                <strong>Fecha de fin:</strong> {{ usuario_empresa.fecha_fin|date:"d/m/Y" }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <form method="post" id="usuarioForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Email del Usuario -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope me-2"></i>{{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.help_text %}
                                    <div class="form-text">{{ form.email.help_text }}</div>
                                {% endif %}
                                <div class="text-danger small" id="email-error"></div>
                            </div>

                            <!-- Contraseña -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.password.id_for_label }}" class="form-label">
                                    <i class="fas fa-lock me-2"></i>
                                    {% if usuario_empresa %}
                                        Nueva Contraseña
                                    {% else %}
                                        {{ form.password.label }}
                                    {% endif %}
                                </label>
                                {{ form.password }}
                                {% if form.password.help_text %}
                                    <div class="form-text">
                                        {% if usuario_empresa %}
                                            <i class="fas fa-info-circle me-1"></i>
                                        {% endif %}
                                        {{ form.password.help_text }}
                                    </div>
                                {% endif %}
                                {% if usuario_empresa %}
                                <div class="form-text text-muted">
                                    <small><i class="fas fa-shield-alt me-1"></i>La contraseña actual se mantendrá si deja este campo en blanco</small>
                                </div>
                                {% endif %}
                                <div class="text-danger small" id="password-error"></div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Sucursal -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.sucursal.id_for_label }}" class="form-label">
                                    <i class="fas fa-building me-2"></i>{{ form.sucursal.label }}
                                </label>
                                {{ form.sucursal }}
                                {% if form.sucursal.errors %}
                                    <div class="text-danger small">{{ form.sucursal.errors.0 }}</div>
                                {% endif %}
                                <div class="text-danger small" id="sucursal-error"></div>
                            </div>

                            <!-- Tipo de Usuario -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.tipo_usuario.id_for_label }}" class="form-label">
                                    <i class="fas fa-user-tag me-2"></i>{{ form.tipo_usuario.label }}
                                </label>
                                {{ form.tipo_usuario }}
                                {% if form.tipo_usuario.errors %}
                                    <div class="text-danger small">{{ form.tipo_usuario.errors.0 }}</div>
                                {% endif %}
                                <div class="text-danger small" id="tipo_usuario-error"></div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Fecha de Inicio -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.fecha_inicio.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-plus me-2"></i>{{ form.fecha_inicio.label }}
                                </label>
                                {{ form.fecha_inicio }}
                                {% if form.fecha_inicio.errors %}
                                    <div class="text-danger small">{{ form.fecha_inicio.errors.0 }}</div>
                                {% endif %}
                                <div class="text-danger small" id="fecha_inicio-error"></div>
                            </div>

                            <!-- Fecha de Fin -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.fecha_fin.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-times me-2"></i>{{ form.fecha_fin.label }}
                                </label>
                                {{ form.fecha_fin }}
                                {% if form.fecha_fin.errors %}
                                    <div class="text-danger small">{{ form.fecha_fin.errors.0 }}</div>
                                {% endif %}
                                <div class="text-danger small" id="fecha_fin-error"></div>
                            </div>
                        </div>

                        <!-- Estado Activo -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    {{ form.activo }}
                                    <label class="form-check-label" for="{{ form.activo.id_for_label }}">
                                        <i class="fas fa-toggle-on me-2"></i>{{ form.activo.label }}
                                    </label>
                                </div>
                                <div class="text-danger small" id="activo-error"></div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'empresa:listar_usuarios_empresa' empresa.id %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>Guardar Usuario
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('usuarioForm');
    const submitBtn = document.getElementById('submitBtn');

    // El widget DateInput personalizado se encarga del formateo automáticamente
    // Solo necesitamos manejar el envío del formulario

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Mostrar loading
        showLoading('Guardando usuario...', 'Por favor espera');
        
        // Deshabilitar botón
        submitBtn.disabled = true;
        
        // Enviar formulario via AJAX
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessAndRedirect(
                    '¡Usuario guardado!',
                    data.message,
                    data.redirect_url
                );
            } else {
                showError('Error', data.message);
                
                // Mostrar errores de validación si existen
                if (data.errors) {
                    Object.keys(data.errors).forEach(field => {
                        const errorElement = document.getElementById(field + '-error');
                        if (errorElement) {
                            errorElement.textContent = data.errors[field][0];
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error', 'Ocurrió un error al guardar el usuario');
        })
        .finally(() => {
            // Habilitar botón
            submitBtn.disabled = false;
        });
    });
});
</script>
{% endblock %} 