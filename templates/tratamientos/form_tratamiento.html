{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Nuevo{% endif %} Tratamiento{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: 1px solid #AED6F1;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }

    .card-header {
        background-color: #E8F4FC;
        border-bottom: 1px solid #AED6F1;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
    }

    .card-header h3 {
        color: #1A5276;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    .card-body {
        padding: 2rem;
    }

    .form-label {
        color: #1A5276;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 1px solid #AED6F1;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #2874A6;
        box-shadow: 0 0 0 0.2rem rgba(40, 116, 166, 0.25);
    }

    .btn-primary {
        background-color: #1A5276;
        border-color: #1A5276;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .btn-primary:hover {
        background-color: #2874A6;
        border-color: #2874A6;
    }

    .section-title {
        color: #1A5276;
        font-size: 1.1rem;
        font-weight: 600;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #AED6F1;
    }

    .section-subtitle {
        color: #666;
        font-size: 0.9rem;
        margin: -0.5rem 0 1.5rem;
        font-weight: normal;
        line-height: 1.4;
    }

    .invalid-feedback {
        color: #e74c3c;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .procedimiento-card {
        background-color: #E8F4FC;
        border: 1px solid #AED6F1;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .procedimiento-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .procedimiento-title {
        color: #1A5276;
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }

    .procedimiento-remove {
        color: #e74c3c;
        cursor: pointer;
        font-size: 1.2rem;
    }

    .procedimiento-remove:hover {
        color: #c0392b;
    }

    .procedimiento-total {
        color: #1A5276;
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #AED6F1;
    }

    .add-procedimiento {
        background-color: #1A5276;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        max-width: 200px;
        margin: 0 auto 1rem;
        color: white;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .add-procedimiento:hover {
        background-color: #2874A6;
        color: white;
        text-decoration: none;
    }

    .add-procedimiento i {
        color: white;
        font-size: 0.9rem;
    }

    .add-procedimiento span {
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .procedimiento-row {
        background-color: #E8F4FC;
        border: 1px solid #AED6F1;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .procedimiento-remove {
        color: #e74c3c;
        cursor: pointer;
        font-size: 1rem;
        padding: 0.5rem;
    }

    .procedimiento-remove:hover {
        color: #c0392b;
    }

    .procedimiento-total {
        color: #1A5276;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #AED6F1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-tooth me-2"></i>{% if form.instance.pk %}Editar{% else %}Nuevo{% endif %} Tratamiento</h3>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        {{ formset.management_form }}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Por favor, corrija los siguientes errores:
                            <ul class="mb-0 mt-2">
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Información Básica -->
                        <h4 class="section-title">Información Básica</h4>
                        <p class="section-subtitle">Complete los datos principales del tratamiento, incluyendo el paciente, profesional y fechas relevantes.</p>
                        <div class="row">
                            <!-- Paciente -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.paciente.id_for_label }}" class="form-label">Paciente *</label>
                                <select name="{{ form.paciente.name }}" id="{{ form.paciente.id_for_label }}" class="form-select" required>
                                    <option value="">Seleccione un paciente</option>
                                    {% for paciente in pacientes %}
                                    <option value="{{ paciente.id }}" {% if form.instance.paciente.id == paciente.id %}selected{% endif %}>
                                        {{ paciente.nombre }} {{ paciente.apellidos }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if form.paciente.errors %}
                                <div class="invalid-feedback d-block">{{ form.paciente.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <!-- Profesional -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.profesional.id_for_label }}" class="form-label">Profesional *</label>
                                <select name="{{ form.profesional.name }}" id="{{ form.profesional.id_for_label }}" class="form-select" required>
                                    <option value="">Seleccione un profesional</option>
                                    {% for profesional in profesionales %}
                                    <option value="{{ profesional.id }}" {% if form.instance.profesional.id == profesional.id %}selected{% endif %}>
                                        {{ profesional.nombres }} {{ profesional.apellido_paterno }} {{ profesional.apellido_materno }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if form.profesional.errors %}
                                <div class="invalid-feedback d-block">{{ form.profesional.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <!-- Fecha de Inicio -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.fecha_inicio.id_for_label }}" class="form-label">Fecha de Inicio *</label>
                                {{ form.fecha_inicio }}
                                {% if form.fecha_inicio.errors %}
                                <div class="invalid-feedback d-block">{{ form.fecha_inicio.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <!-- Fecha de Fin -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.fecha_fin.id_for_label }}" class="form-label">Fecha de Fin</label>
                                {{ form.fecha_fin }}
                                {% if form.fecha_fin.errors %}
                                <div class="invalid-feedback d-block">{{ form.fecha_fin.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <!-- Estado -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.estado.id_for_label }}" class="form-label">Estado *</label>
                                <select name="{{ form.estado.name }}" id="{{ form.estado.id_for_label }}" class="form-select" required>
                                    <option value="">Seleccione un estado</option>
                                    {% for value, label in form.estado.field.choices %}
                                    <option value="{{ value }}" {% if form.instance.estado == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if form.estado.errors %}
                                <div class="invalid-feedback d-block">{{ form.estado.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <!-- Pagado -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    {{ form.pagado }}
                                    <label class="form-check-label" for="{{ form.pagado.id_for_label }}">
                                        Tratamiento Pagado
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Procedimientos -->
                        <h4 class="section-title">Procedimientos</h4>
                        <p class="section-subtitle">Agregue los procedimientos dentales que se realizarán en este tratamiento. Puede especificar la cantidad y aplicar descuentos si es necesario.</p>
                        <div id="procedimientos-container">
                            {% for form in formset %}
                            <div class="procedimiento-row">
                                <div class="row align-items-center">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">Procedimiento *</label>
                                        <select name="{{ form.procedimiento.name }}" id="{{ form.procedimiento.id_for_label }}" class="form-select procedimiento-select" required>
                                            <option value="">Seleccione un procedimiento</option>
                                            {% for procedimiento in procedimientos %}
                                            <option value="{{ procedimiento.id }}" 
                                                    data-precio="{{ procedimiento.valor }}"
                                                    {% if form.procedimiento.value == procedimiento.id %}selected{% endif %}>
                                                {{ procedimiento.nombre }} - ${{ procedimiento.valor }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.procedimiento.errors %}
                                        <div class="invalid-feedback d-block">{{ form.procedimiento.errors|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Precio</label>
                                        <input type="text" class="form-control precio" value="" readonly>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" name="{{ form.cantidad.name }}" id="{{ form.cantidad.id_for_label }}" 
                                               class="form-control cantidad" value="{{ form.cantidad.value|default:'1' }}" min="1" required>
                                        {% if form.cantidad.errors %}
                                        <div class="invalid-feedback d-block">{{ form.cantidad.errors|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Descuento (%)</label>
                                        <input type="number" name="{{ form.descuento.name }}" id="{{ form.descuento.id_for_label }}" 
                                               class="form-control descuento" value="{{ form.descuento.value|default:'0' }}" min="0" max="100" step="0.01">
                                        {% if form.descuento.errors %}
                                        <div class="invalid-feedback d-block">{{ form.descuento.errors|join:", " }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1 mb-2">
                                        <label class="form-label">Total</label>
                                        <div class="procedimiento-total">
                                            $<span class="total">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-1 mb-2 text-end">
                                        {% if form.instance.pk %}
                                        {{ form.DELETE }}
                                        {% endif %}
                                        <i class="fas fa-times procedimiento-remove" style="cursor: pointer;"></i>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="text-center">
                            <button type="button" class="add-procedimiento" id="add-procedimiento">
                                <i class="fas fa-plus"></i>
                                <span>Agregar Procedimiento</span>
                            </button>
                        </div>

                        <!-- Observaciones -->
                        <h4 class="section-title">Observaciones</h4>
                        <p class="section-subtitle">Agregue cualquier información adicional relevante para el tratamiento, como notas especiales o consideraciones importantes.</p>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label">Observaciones</label>
                                {{ form.observaciones }}
                                {% if form.observaciones.errors %}
                                <div class="invalid-feedback d-block">{{ form.observaciones.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Guardar Tratamiento
                                </button>
                                <a href="{% url 'tratamientos:lista' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Función para calcular totales
    function calcularTotales(row) {
        const select = row.find('.procedimiento-select');
        const cantidad = row.find('.cantidad');
        const descuento = row.find('.descuento');
        const totalSpan = row.find('.total');
        const precioInput = row.find('.precio');

        const precio = parseFloat(select.find('option:selected').data('precio')) || 0;
        const cant = parseInt(cantidad.val()) || 0;
        const desc = parseFloat(descuento.val()) || 0;

        precioInput.val(precio.toFixed(2));
        const subtotal = precio * cant;
        const descuentoMonto = (subtotal * desc) / 100;
        const total = subtotal - descuentoMonto;

        totalSpan.text(total.toFixed(2));
    }

    // Función para configurar los listeners de un procedimiento
    function setupProcedimientoListeners(row) {
        const select = row.find('.procedimiento-select');
        const cantidad = row.find('.cantidad');
        const descuento = row.find('.descuento');
        const precioInput = row.find('.precio');
        const removeBtn = row.find('.procedimiento-remove');

        function updateTotalesYPrecio() {
            const precio = parseFloat(select.find('option:selected').data('precio')) || 0;
            precioInput.val(precio.toFixed(2));
            calcularTotales(row);
        }

        select.on('change', updateTotalesYPrecio);
        cantidad.on('input', updateTotalesYPrecio);
        descuento.on('input', updateTotalesYPrecio);

        if (removeBtn.length) {
            removeBtn.on('click', function() {
                const deleteCheckbox = row.find('input[name$="-DELETE"]');
                if (deleteCheckbox.length) {
                    deleteCheckbox.prop('checked', true);
                    row.hide();
                } else {
                    row.remove();
                }
            });
        }

        // Mostrar el precio inicial si ya hay un procedimiento seleccionado
        if (select.val()) {
            updateTotalesYPrecio();
        }
    }

    // Configurar los listeners para los procedimientos existentes
    $('.procedimiento-row').each(function() {
        setupProcedimientoListeners($(this));
    });

    // Función para agregar un nuevo procedimiento
    $('#add-procedimiento').on('click', function() {
        const formset = $('#id_detalles-TOTAL_FORMS');
        const totalForms = parseInt(formset.val());
        const maxForms = parseInt($('#id_detalles-MAX_NUM_FORMS').val());

        if (totalForms >= maxForms) {
            alert('No se pueden agregar más procedimientos');
            return;
        }

        // Clone el primer procedimiento
        const newRow = $('.procedimiento-row:first').clone();
        
        // Actualizar los IDs y nombres de los campos
        newRow.find('input, select').each(function() {
            const name = $(this).attr('name');
            if (name) {
                $(this).attr('name', name.replace('-0-', `-${totalForms}-`));
                $(this).attr('id', $(this).attr('id').replace('-0-', `-${totalForms}-`));
            }
        });
        
        // Limpiar los valores
        newRow.find('select').val('');
        newRow.find('input[type="number"]').val('1');
        newRow.find('.precio').val('');
        newRow.find('.total').text('0');
        
        // Agregar al contenedor
        $('#procedimientos-container').append(newRow);
        
        // Actualizar el contador de formularios
        formset.val(totalForms + 1);
        
        // Configurar los listeners para la nueva fila
        setupProcedimientoListeners(newRow);
    });

    // Calcular totales iniciales para todos los procedimientos
    $('.procedimiento-row').each(function() {
        const row = $(this);
        const select = row.find('.procedimiento-select');
        if (select.val()) {
            setupProcedimientoListeners(row);
        }
    });
});
</script>
{% endblock %}