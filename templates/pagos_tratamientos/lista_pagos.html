{% extends 'base.html' %}
{% load humanize %}

{% block title %}Pagos de Tratamientos{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        position: relative;
        padding: 1.75rem;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-icon {
        position: absolute;
        right: 1.5rem;
        bottom: 1rem;
        font-size: 4.5rem;
        opacity: 0.15;
        transform: rotate(-5deg);
        transition: all 0.3s ease;
    }

    .stats-card:hover .stats-icon {
        transform: rotate(0deg) scale(1.1);
        opacity: 0.2;
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .stats-label {
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 1;
        opacity: 0.9;
    }

    .card-total {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }

    .card-pendientes {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
    }

    .card-completados {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
    }

    .card-anulados {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
    }

    .content-card {
        background: white;
        border-radius: 1rem;
        padding: 1.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }

    .content-card .card-header {
        background: none;
        border: none;
        padding: 0 0 1rem 0;
    }

    .content-card .card-title {
        color: #2d3748;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .content-card .card-title i {
        color: #4a5568;
        opacity: 0.7;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f7fafc;
        color: #4a5568;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }

    .badge {
        padding: 0.5em 1em;
        font-weight: 500;
        border-radius: 9999px;
    }

    .badge-pendiente {
        background-color: #ed8936;
        color: white;
    }

    .badge-completado {
        background-color: #38a169;
        color: white;
    }

    .badge-anulado {
        background-color: #e53e3e;
        color: white;
    }

    .btn-icon {
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Tarjetas de estadísticas -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="stats-card card-total">
                <div class="stats-number">${{ total_pagos|floatformat:0|intcomma }}</div>
                <div class="stats-label">Total Pagado</div>
                <i class="fas fa-dollar-sign stats-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card card-pendientes">
                <div class="stats-number">{{ pagos_pendientes }}</div>
                <div class="stats-label">Pagos Pendientes</div>
                <i class="fas fa-clock stats-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card card-completados">
                <div class="stats-number">{{ pagos_completados }}</div>
                <div class="stats-label">Pagos Completados</div>
                <i class="fas fa-check-circle stats-icon"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card card-anulados">
                <div class="stats-number">{{ pagos_anulados }}</div>
                <div class="stats-label">Pagos Anulados</div>
                <i class="fas fa-ban stats-icon"></i>
            </div>
        </div>
    </div>

    <!-- Lista de pagos -->
    <div class="content-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title">
                <i class="fas fa-money-bill-wave"></i>
                {% if tratamiento %}
                    Pagos del Tratamiento #{{ tratamiento.id }}
                {% else %}
                    Lista de Pagos
                {% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            {% if pagos %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Tratamiento</th>
                            <th>Forma de Pago</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                        <tr>
                            <td>#{{ pago.id }}</td>
                            <td>{{ pago.fecha_pago|date:"d/m/Y H:i" }}</td>
                            <td>
                                <a href="{% url 'tratamientos:detalle_tratamiento' pago.tratamiento.id %}" class="text-decoration-none">
                                    {{ pago.tratamiento.paciente.nombre_completo }}
                                </a>
                            </td>
                            <td>{{ pago.forma_pago.nombre }}</td>
                            <td>${{ pago.monto|floatformat:0|intcomma }}</td>
                            <td>
                                <span class="badge badge-{{ pago.estado|lower }}">
                                    {{ pago.get_estado_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'pagos_tratamientos:detalle_pago' pago.id %}" 
                                       class="btn btn-icon btn-light" title="Ver detalles">
                                        <i class="fas fa-eye text-primary"></i>
                                    </a>
                                    {% if pago.estado != 'ANULADO' %}
                                    <a href="{% url 'pagos_tratamientos:editar_pago' pago.id %}" 
                                       class="btn btn-icon btn-light" title="Editar">
                                        <i class="fas fa-edit text-info"></i>
                                    </a>
                                    <button type="button" class="btn btn-icon btn-light" 
                                            onclick="confirmarAnulacion({{ pago.id }})" title="Anular">
                                        <i class="fas fa-times text-danger"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay pagos registrados</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Anulación -->
<div class="modal fade" id="modalAnulacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Anular Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea anular este pago?</p>
                <div class="mb-3">
                    <label for="motivo_anulacion" class="form-label">Motivo de la anulación</label>
                    <textarea class="form-control" id="motivo_anulacion" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="anularPago()">Anular</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let pagoIdAnular = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar variables
        let pagoIdAnular = null;
        const modalAnulacion = new bootstrap.Modal(document.getElementById('modalAnulacion'));

        // Función para confirmar anulación
        window.confirmarAnulacion = function(pagoId) {
            pagoIdAnular = pagoId;
            document.getElementById('motivo_anulacion').value = '';
            modalAnulacion.show();
        };

        // Función para anular pago
        window.anularPago = function() {
            if (!pagoIdAnular) return;
            
            const motivo = document.getElementById('motivo_anulacion').value;
            if (!motivo.trim()) {
                alert('Por favor, ingrese un motivo para la anulación');
                return;
            }
            
            fetch(`/pagos/anular/${pagoIdAnular}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ motivo_anulacion: motivo })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    modalAnulacion.hide();
                    location.reload();
                } else {
                    alert('Error al anular el pago: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al anular el pago: ' + error.message);
            });
        };
    });
</script>
{% endblock %}
