{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ accion }} Caja{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header de la página -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-cash-register me-2"></i>
                                {{ accion }} Caja
                            </h4>
                            <small class="opacity-75">
                                {% if accion == 'Crear' %}
                                    Crear nuevo cierre de caja
                                {% else %}
                                    Editar cierre de caja existente
                                {% endif %}
                            </small>
                        </div>
                        <a href="{% url 'cierres_caja:lista' %}" class="btn btn-light">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver
                        </a>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Información básica -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información del Cierre
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.fecha.id_for_label }}" class="form-label">Fecha *</label>
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                    <div class="invalid-feedback d-block">{{ form.fecha.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.estado.id_for_label }}" class="form-label">Estado *</label>
                                {{ form.estado }}
                                {% if form.estado.errors %}
                                    <div class="invalid-feedback d-block">{{ form.estado.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Montos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    Montos
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.total_ingresos.id_for_label }}" class="form-label">Total Ingresos *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.total_ingresos }}
                                </div>
                                {% if form.total_ingresos.errors %}
                                    <div class="invalid-feedback d-block">{{ form.total_ingresos.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="{{ form.total_egresos.id_for_label }}" class="form-label">Total Egresos *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.total_egresos }}
                                </div>
                                {% if form.total_egresos.errors %}
                                    <div class="invalid-feedback d-block">{{ form.total_egresos.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="{{ form.saldo_final.id_for_label }}" class="form-label">Saldo Final *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.saldo_final }}
                                </div>
                                {% if form.saldo_final.errors %}
                                    <div class="invalid-feedback d-block">{{ form.saldo_final.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-comment-alt me-2"></i>
                                    Observaciones
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label">Observaciones</label>
                                {{ form.observaciones }}
                                {% if form.observaciones.errors %}
                                    <div class="invalid-feedback d-block">{{ form.observaciones.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ form.non_field_errors|join:", " }}
                            </div>
                        {% endif %}

                        <!-- Botones de acción -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{% url 'cierres_caja:lista' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        {% if accion == 'Crear' %}
                                            Crear Cierre
                                        {% else %}
                                            Actualizar Cierre
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calcular saldo final cuando cambien los ingresos o egresos
    const totalIngresos = document.getElementById('id_total_ingresos');
    const totalEgresos = document.getElementById('id_total_egresos');
    const saldoFinal = document.getElementById('id_saldo_final');

    function calcularSaldo() {
        const ingresos = parseFloat(totalIngresos.value) || 0;
        const egresos = parseFloat(totalEgresos.value) || 0;
        const saldo = ingresos - egresos;
        saldoFinal.value = saldo.toFixed(2);
    }

    if (totalIngresos && totalEgresos && saldoFinal) {
        totalIngresos.addEventListener('input', calcularSaldo);
        totalEgresos.addEventListener('input', calcularSaldo);
    }

    // Formatear números con separadores de miles
    function formatearNumero(input) {
        let valor = input.value.replace(/[^\d.]/g, '');
        if (valor) {
            let numero = parseFloat(valor);
            if (!isNaN(numero)) {
                input.value = numero.toLocaleString('es-CL');
            }
        }
    }

    // Aplicar formateo a los campos numéricos
    const camposNumericos = [totalIngresos, totalEgresos, saldoFinal];
    camposNumericos.forEach(campo => {
        if (campo) {
            campo.addEventListener('blur', function() {
                formatearNumero(this);
            });
            campo.addEventListener('focus', function() {
                this.value = this.value.replace(/[^\d.]/g, '');
            });
        }
    });
});
</script>
{% endblock %}