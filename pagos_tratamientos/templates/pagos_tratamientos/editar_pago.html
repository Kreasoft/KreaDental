{% extends 'core/base.html' %}

{% block title %}Editar Pago{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Editar Pago</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-1">Información del Pago</h6>
                        <p class="mb-1">
                            <strong>Paciente:</strong> {{ tratamiento.paciente.nombre_completo }} |
                            <strong>Procedimiento:</strong> {{ tratamiento.procedimiento.nombre }}
                        </p>
                        <p class="mb-1">
                            <strong>Fecha del Pago:</strong> {{ pago.fecha_pago|date:"d/m/Y H:i" }} |
                            <strong>Estado:</strong> 
                            {% if pago.estado == 'COMPLETADO' %}
                                <span class="badge bg-success">Completado</span>
                            {% elif pago.estado == 'PENDIENTE' %}
                                <span class="badge bg-warning text-dark">Pendiente</span>
                            {% elif pago.estado == 'ANULADO' %}
                                <span class="badge bg-danger">Anulado</span>
                            {% endif %}
                        </p>
                        <p class="mb-0">
                            <strong>Monto Actual del Pago:</strong> <span class="text-primary fw-bold">${{ pago.monto|floatformat:2 }}</span>
                        </p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Costo Total</h6>
                                    <h4 class="text-primary">${{ tratamiento.costo_total|floatformat:0 }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Total Pagado</h6>
                                    <h4 class="text-success">${{ total_pagado|floatformat:0 }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Saldo Pendiente</h6>
                                    <h4 class="text-warning">${{ saldo_pendiente|floatformat:0 }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="monto" class="form-label">Monto del Pago</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" 
                                       class="form-control" id="monto" name="monto" 
                                       value="{{ pago.monto }}" required>
                            </div>
                            <div class="form-text">
                                Monto actual: ${{ pago.monto|floatformat:2 }} | 
                                Saldo disponible: ${{ saldo_pendiente|add:pago.monto|floatformat:2 }}
                            </div>
                        </div>

                        <script>
                            // Establecer el valor del monto después de que se cargue la página
                            document.addEventListener('DOMContentLoaded', function() {
                                const montoInput = document.getElementById('monto');
                                const montoValue = '{{ pago.monto }}';
                                
                                console.log('Valor original del monto:', montoValue);
                                
                                // Limpiar completamente el valor
                                let montoFormateado = montoValue;
                                
                                // Remover todos los caracteres no numéricos excepto punto y coma
                                montoFormateado = montoValue.replace(/[^\d.,]/g, '');
                                
                                // Convertir coma a punto
                                montoFormateado = montoFormateado.replace(',', '.');
                                
                                // Asegurar que solo haya un punto decimal
                                const parts = montoFormateado.split('.');
                                if (parts.length > 2) {
                                    montoFormateado = parts[0] + '.' + parts.slice(1).join('');
                                }
                                
                                console.log('Valor formateado:', montoFormateado);
                                
                                // Validar que sea un número válido
                                if (montoFormateado && !isNaN(parseFloat(montoFormateado))) {
                                    montoInput.value = montoFormateado;
                                    console.log('Valor establecido en input:', montoFormateado);
                                } else {
                                    // Si no se puede convertir, usar 0
                                    montoInput.value = '0.00';
                                    console.log('Valor no válido, establecido 0.00');
                                }
                                
                                // Agregar validación en tiempo real
                                montoInput.addEventListener('input', function(e) {
                                    let value = e.target.value;
                                    
                                    // Permitir solo números, punto y coma
                                    value = value.replace(/[^\d.,]/g, '');
                                    
                                    // Convertir coma a punto si es necesario
                                    if (value.includes(',')) {
                                        value = value.replace(',', '.');
                                    }
                                    
                                    // Asegurar que solo haya un punto decimal
                                    const parts = value.split('.');
                                    if (parts.length > 2) {
                                        value = parts[0] + '.' + parts.slice(1).join('');
                                    }
                                    
                                    // Validar que sea un número válido
                                    if (value && !isNaN(parseFloat(value))) {
                                        e.target.value = value;
                                    }
                                });
                                
                                // Validar antes de enviar el formulario
                                const form = montoInput.closest('form');
                                form.addEventListener('submit', function(e) {
                                    const value = montoInput.value.trim();
                                    
                                    if (!value) {
                                        e.preventDefault();
                                        alert('Por favor ingrese un monto válido');
                                        return;
                                    }
                                    
                                    // Limpiar el valor antes de enviar
                                    let cleanValue = value.replace(/[^\d.,]/g, '');
                                    cleanValue = cleanValue.replace(',', '.');
                                    
                                    const parts = cleanValue.split('.');
                                    if (parts.length > 2) {
                                        cleanValue = parts[0] + '.' + parts.slice(1).join('');
                                    }
                                    
                                    if (isNaN(parseFloat(cleanValue))) {
                                        e.preventDefault();
                                        alert('Por favor ingrese un monto válido');
                                        return;
                                    }
                                    
                                    // Establecer el valor limpio en el campo
                                    montoInput.value = cleanValue;
                                });
                            });
                        </script>

                        <div class="mb-3">
                            <label for="forma_pago" class="form-label">Forma de Pago</label>
                            <select class="form-select" id="forma_pago" name="forma_pago" required>
                                {% for forma in formas_pago %}
                                <option value="{{ forma.id }}" {% if forma.id == pago.forma_pago.id %}selected{% endif %}>
                                    {{ forma.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="comprobante" class="form-label">Número de Comprobante</label>
                            <input type="text" class="form-control" id="comprobante" name="comprobante" value="{{ pago.comprobante }}">
                            <div class="form-text">Opcional: número de factura, recibo o comprobante</div>
                        </div>

                        <div class="mb-3">
                            <label for="notas" class="form-label">Notas</label>
                            <textarea class="form-control" id="notas" name="notas" rows="3">{{ pago.notas }}</textarea>
                            <div class="form-text">Opcional: cualquier información adicional sobre el pago</div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'pagos_tratamientos:detalle_pago' pago.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
